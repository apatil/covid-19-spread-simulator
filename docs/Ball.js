import{BALL_RADIUS,MORTALITY_PERCENTATGE,TICKS_TO_RECOVER,RUN,SPEED,STATES,HANDWASHING_EFFECTIVENESS,MASK_EFFECTIVENESS,GOWN_EFFECTIVENESS,N95_MASK_EFFECTIVENESS,GLOVE_EFFECTIVENESS,HAND_MASK_GOWN_EFFECTIVENESS,DEFAULT_INTERVENTION_PARAMETERS,TICKS_PER_DAY,INTERVENTION_BADGES}from"./options.js";import{checkCollision,calculateChangeDirection}from"./collisions.js";function isPrevented(t){let e=DEFAULT_INTERVENTION_PARAMETERS.baselineTransmissionProbability;(t.interventions.glove||t.interventions.handwash)&&t.interventions.mask&&t.interventions.gown?e*=1-HAND_MASK_GOWN_EFFECTIVENESS:(t.interventions.handwash&&!t.interventions.glove&&(e*=1-HANDWASHING_EFFECTIVENESS),t.interventions.mask&&!t.interventions.n95&&(e*=1-MASK_EFFECTIVENESS),t.interventions.glove&&(e*=1-GLOVE_EFFECTIVENESS),t.interventions.n95&&(e*=1-N95_MASK_EFFECTIVENESS),t.interventions.gown&&(e*=1-GOWN_EFFECTIVENESS));const s=1-e;return t.sketch.random(0,1)<s}export class Ball{constructor({x:t,y:e,id:s,state:i,sketch:E,hasMovement:n}){this.x=t,this.y=e,this.vx=E.random(-1,1)*SPEED/Math.SQRT2,this.vy=E.random(-1,1)*SPEED/Math.SQRT2,this.sketch=E,this.id=s,this.state=i,this.timeInfected=0,this.timeSinceTestDay=0,this.hasMovement=n,this.hasCollision=!0,this.survivor=!1,this.quarantined=!1,this.essentialWorker=E.random(0,1)<DEFAULT_INTERVENTION_PARAMETERS.essentialPct/100,this.interventions={handwash:E.random(0,1)<DEFAULT_INTERVENTION_PARAMETERS.handwashPct/100,gown:E.random(0,1)<DEFAULT_INTERVENTION_PARAMETERS.gownPct/100,mask:E.random(0,1)<DEFAULT_INTERVENTION_PARAMETERS.maskPct/100,n95:E.random(0,1)<DEFAULT_INTERVENTION_PARAMETERS.n95Pct/100,gloves:E.random(0,1)<DEFAULT_INTERVENTION_PARAMETERS.glovesPct/100}}checkState(){if(this.state===STATES.infected){if(RUN.filters.death&&!this.survivor&&this.timeInfected>=TICKS_TO_RECOVER/2){if(this.survivor=this.sketch.random(100)>=MORTALITY_PERCENTATGE,!this.survivor)return this.hasMovement=!1,this.state=STATES.death,RUN.results[STATES.infected]--,void RUN.results[STATES.death]++;this.quarantined&&(this.hasMovement=!1)}this.timeInfected>=TICKS_TO_RECOVER?(this.quarantined&&RUN.results[STATES.quarantined]--,this.quarantined=!1,this.hasMovement=!0,this.state=STATES.recovered,RUN.results[STATES.infected]--,RUN.results[STATES.recovered]++):this.timeInfected++}}test(){this.state!==STATES.infected||this.quarantined||(this.quarantined=!0,this.hasMovement=!1,RUN.results[STATES.quarantined]++)}maybeTest(){this.timeSinceTestDay>DEFAULT_INTERVENTION_PARAMETERS.testFrequency*TICKS_PER_DAY?(this.timeSinceTestDay=0,this.sketch.random(0,1)<DEFAULT_INTERVENTION_PARAMETERS.testPct/100&&this.test()):this.timeSinceTestDay++}checkCollisions({others:t}){if(this.state!==STATES.death)for(let e=this.id+1;e<t.length;e++){const s=t[e],{state:i,x:E,y:n}=s;if(i===STATES.death)continue;const T=E-this.x,h=n-this.y;let S=!1,a=2*BALL_RADIUS;if(this.sketch.random(0,1)<DEFAULT_INTERVENTION_PARAMETERS.socialDistancePct/100&&(a=3*BALL_RADIUS,S=!0),checkCollision({dx:T,dy:h,diameter:a})){const{ax:t,ay:e}=calculateChangeDirection({dx:T,dy:h,scale:S+1});if(this.vx-=t,this.vy-=e,s.vx=t,s.vy=e,this.state===i)return;if(this.state===STATES.recovered||i===STATES.recovered)return;this.state!==STATES.infected||this.quarantined||s.state!==STATES.well||isPrevented(s)||S||(s.state=STATES.infected,RUN.results[STATES.infected]++,RUN.results[STATES.well]--),s.state!==STATES.infected||s.quarantined||this.state!==STATES.well||isPrevented(this)||S||(this.state=STATES.infected,RUN.results[STATES.infected]++,RUN.results[STATES.well]--)}}}move(){this.hasMovement&&(DEFAULT_INTERVENTION_PARAMETERS.emergencyLockdown&&!this.essentialWorker||(this.x+=this.vx,this.y+=this.vy,(this.x+BALL_RADIUS>this.sketch.width&&this.vx>0||this.x-BALL_RADIUS<0&&this.vx<0)&&(this.vx*=-1),(this.y+BALL_RADIUS>this.sketch.height&&this.vy>0||this.y-BALL_RADIUS<0&&this.vy<0)&&(this.vy*=-1)))}render(){let t=this.state;this.quarantined&&(t="quarantined");for(let e=0;e<INTERVENTION_BADGES.length;e++){const s=INTERVENTION_BADGES[e];this.interventions[s]&&(t+="-"+s)}const e=this.sketch.sprite_lookup[t],[s,i,E,n]=e;this.sketch.drawingContext.drawImage(this.sketch.sprite,s,i,E,n,this.x-E/2,this.y-n/2,E,n)}}
